{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "deploymentPrefix": {
            "type": "string",
            "maxLength": 10,
            "metadata": {
                "displayName": "Deployment prefix",
                "description": "Provide a prefix (max 10 characters, unique at tenant-scope) for subscription resources created as part of this deploy."
            },
            "defaultValue": "cafsecure"
        },
        "deploymentUniqueId": {
            "type": "string",
            "metadata": {
                "displayName": "Deployment Unique Id",
                "description": "Autogenerated ID to identify each deploy."
            },
            "defaultValue": "[newGuid()]"
        },
        "emailSecurityContact": {
            "type": "String",
            "metadata": {
                "displayName": "Azure Security Center Email Contact",
                "description": "Email address to get email notifications from Azure Security Center"
            }
        },
        "enableCISInitiative": {
            "type": "string",
            "metadata": {
                "displayName": "Enable CIS Microsoft Azure Foundations Benchmark initiative",
                "description": "If 'Yes', ARM will assign the CIS Microsoft Azure Foundations Benchmark initiative to the subscription. If 'No', it will be skipped"
            },
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ]
        },
        "retentionInDays": {
            "type": "int",
            "metadata": {
                "displayName": "Data retention (days)",
                "description": "Select data retention (days) for Log Analytics."
            },
            "defaultValue": 30
        },
        "enableLogs": {
            "type": "String",
            "metadata": {
                "displayName": "Enable logs",
                "description": "If 'Yes', ARM will enable logs stream to the log analytics workspace. If 'No', they will be disabled"
            },
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ]
        },
        "enableAscForServers": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForAppServices": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForStorage": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForSql": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForSqlOnVm": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForArm": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForDns": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "enableAscForRegistries": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Free"
            ]
        },
        "deployHubSpokeTopology": {
            "type": "String",
            "metadata": {
                "displayName": "Deploy Hub-spoke network topology with Azure Virtual WAN",
                "description": "If 'Yes', ARM will deploy hub-spoke network topology to the subscription. If 'No', it will be skipped"
            },
            "defaultValue": "Yes",
            "allowedValues": [
                "Yes",
                "No"
            ]
        },
        "spokeNetworkOneNetAddressPrefix": {
            "type": "string",
            "metadata": {
                "displayName": "IP address prefix for the spoke one network"
            },
            "defaultValue": "10.1.0.0/16"
        },
        "spokeNetworkOneSubnetAddressPrefix": {
            "type": "string",
            "metadata": {
                "displayName": "IP address prefix for the spoke one subnet"
            },
            "defaultValue": "10.1.0.0/24"
        },
        "spokeNetworkTwoNetAddressPrefix": {
            "type": "string",
            "metadata": {
                "displayName": "IP address prefix for the spoke two network"
            },
            "defaultValue": "10.2.0.0/16"
        },
        "spokeNetworkTwoSubnetAddressPrefix": {
            "type": "string",
            "metadata": {
                "displayName": "IP address prefix for the spoke two subnet"
            },
            "defaultValue": "10.2.0.0/24"
        },
        "hubNetworkNetAddressPrefix": {
            "type": "string",
            "metadata": {
                "displayName": "IP address prefix for the hub network"
            },
            "defaultValue": "192.168.0.0/16"
        }
    },
    "variables": {
        "templateRootUri": "https://raw.githubusercontent.com/mspnp/caf-secure-amp-infra/pabrus/hubspoke/deploy/auxiliary/",
        "logsEnabled": "[if(equals(parameters('enableLogs'), 'Yes'), 'True', 'False')]",
        "resourceGroupName": "[concat('rg-', parameters('deploymentPrefix'))]",
        "resourceGroupId": "[subscriptionResourceId('Microsoft.Resources/resourceGroups/', variables('resourceGroupName'))]",

        "hubSpokeDeploymentName": "[concat('deployment-', parameters('deploymentPrefix'), '-hubspoke')]",

        "workspaceName": "[concat('log-', parameters('deploymentPrefix'))]",
        "workspaceId": "[concat(subscription().id, '/resourceGroups/', variables('resourceGroupName'), '/providers/Microsoft.OperationalInsights/workspaces/', variables('workspaceName'))]",
        "workspaceDeploymentName": "[concat('deployment-', parameters('deploymentPrefix'), '-log')]",
        "workspaceDeploymentId": "[concat(subscription().id, '/resourceGroups/', variables('resourceGroupName'), '/providers/Microsoft.Resources/deployments/', variables('workspaceDeploymentName'))]",

        "policyDefinitionName-Prefix": "[concat('policy-', parameters('deploymentPrefix'), '-')]",
        "policyDefinitionName-ASCEnableAppService": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-AppService')]",
        "policyDefinitionName-ASCEnableARM": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-ARM')]",
        "policyDefinitionName-ASCEnableContainer": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-ContainerRegistry')]",
        "policyDefinitionName-ASCEnableDNS": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-DNS')]",
        "policyDefinitionName-ASCEnableServers": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-Servers')]",
        "policyDefinitionName-ASCEnableSqlServers": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-SqlServers')]",
        "policyDefinitionName-ASCEnableSqlServerVMs": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-SqlServerVMs')]",
        "policyDefinitionName-ASCEnableStorageAccounts": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AzureDefender-StorageAccounts')]",
        "policyDefinitionName-ASCEnableSecurityContacts": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-SecurityContacts')]",
        "policyDefinitionName-ASCEnableAutoProvision": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-AutoProvision')]",
        "policySetDefinitionName-ASCEnableSecurityCenter": "[concat(variables('policyDefinitionName-Prefix'), 'ASC-Enable-SecurityCenter')]",

        "policyDefinitionId-ASCEnableAppService": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableAppService'))]",
        "policyDefinitionId-ASCEnableARM": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableARM'))]",
        "policyDefinitionId-ASCEnableContainer": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableContainer'))]",
        "policyDefinitionId-ASCEnableDNS": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableDNS'))]",
        "policyDefinitionId-ASCEnableServers": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableServers'))]",
        "policyDefinitionId-ASCEnableSqlServers": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableSqlServers'))]",
        "policyDefinitionId-ASCEnableSqlServerVMs": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableSqlServerVMs'))]",
        "policyDefinitionId-ASCEnableStorageAccounts": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableStorageAccounts'))]",
        "policyDefinitionId-ASCEnableSecurityContacts": "[subscriptionResourceId('Microsoft.Authorization/policyDefinitions', variables('policyDefinitionName-ASCEnableSecurityContacts'))]",
        "policyDefinitionId-ASCEnableAutoProvision": "/providers/Microsoft.Authorization/policyDefinitions/8e7da0a5-0a0e-4bbc-bfc0-7773c018b616",
        "policyDefinitionId-ASCEnableSecurityCenter": "[subscriptionResourceId('Microsoft.Authorization/policySetDefinitions', variables('policySetDefinitionName-ASCEnableSecurityCenter'))]",
        "policyDefinitionId-SendActivityLogToLog": "/providers/Microsoft.Authorization/policyDefinitions/2465583e-4e78-4c15-b6be-a36cbc7c8b0f",
        "policyDefinitionId-AzureSecurityBenchmark": "/providers/Microsoft.Authorization/policySetDefinitions/1f3afdf9-d0c9-4c3d-847f-89da613e70a8",
        "policyDefinitionId-CISMicrosoftAzureFoundationsBenchmarks": "/providers/Microsoft.Authorization/policySetDefinitions/612b5213-9160-4969-8578-1518bd2a000c",

        "policyAssignmentName-Prefix": "[concat('assign-', parameters('deploymentPrefix'), '-')]",
        "policyAssignmentName-EnableSecurityCenter": "[concat(variables('policyAssignmentName-Prefix'), 'EnableSecurityCenter')]",
        "policyAssignmentName-SendActivityLogToLog": "[concat(variables('policyAssignmentName-Prefix'), 'SendActivityLogToLog')]",
        "policyAssignmentName-AzureSecurityBenchmark": "[concat(variables('policyAssignmentName-Prefix'), 'AzureSecurityBenchmark')]",
        "policyAssignmentName-CISMicrosoftAzureFoundationsBenchmarks": "[concat(variables('policyAssignmentName-Prefix'), 'CISMicrosoftAzureFoundationsBenchmarks')]",

        "policyAssignmentId-SendActivityLogToLog": "[subscriptionResourceId('Microsoft.Authorization/policyAssignments', variables('policyAssignmentName-SendActivityLogToLog'))]",
        "policyAssignmentId-EnableSecurityCenter": "[subscriptionResourceId('Microsoft.Authorization/policyAssignments', variables('policyAssignmentName-EnableSecurityCenter'))]",

        "roleId-SecurityAdmin": "/providers/Microsoft.Authorization/roleDefinitions/fb1c8493-542b-48eb-b624-b4c8fea62acd",
        "roleId-Contributor": "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
        "roleId-MonitoringContributor": "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
        "roleId-LogAnalyticsContributor": "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
    },
    "resources": [
        // Deploy resource group for log workspace
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-10-01",
            "name": "[variables('resourceGroupName')]",
            "location": "[deployment().location]",
            "properties": {}
        },

        // Deploy log workspace into resource group
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "[variables('workspaceDeploymentName')]",
            "resourceGroup": "[variables('resourceGroupName')]",
            "dependsOn": [
                "[variables('resourceGroupId')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), 'caf-secure-logAnalyticsWorkspace.json')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[variables('workspaceName')]"
                    },
                    "retentionInDays": {
                        "value": "[parameters('retentionInDays')]"
                    }
                }
            }
        },

        // Deploy hubspoke network into resource group
        {
            "condition": "[equals(parameters('deployHubSpokeTopology'), 'Yes')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "[variables('hubSpokeDeploymentName')]",
            "resourceGroup": "[variables('resourceGroupName')]",
            "dependsOn": [
                "[variables('resourceGroupId')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templateRootUri'), 'caf-secure-hubSpoke.json')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters": {
                    "deploymentPrefix": {
                        "value": "[parameters('deploymentPrefix')]"
                    },
                    "spokeNetworkOneNetAddressPrefix": {
                        "value": "[parameters('spokeNetworkOneNetAddressPrefix')]"
                    },
                    "spokeNetworkOneSubnetAddressPrefix": {
                        "value": "[parameters('spokeNetworkOneSubnetAddressPrefix')]"
                    },
                    "spokeNetworkTwoNetAddressPrefix": {
                        "value": "[parameters('spokeNetworkTwoNetAddressPrefix')]"
                    },
                    "spokeNetworkTwoSubnetAddressPrefix": {
                        "value": "[parameters('spokeNetworkTwoSubnetAddressPrefix')]"
                    },
                    "hubNetworkNetAddressPrefix": {
                        "value": "[parameters('hubNetworkNetAddressPrefix')]"
                    }
                }
            }
        },

        // Deploy diagnostic setting for Activity log
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2017-05-01-preview",
            "location": "[deployment().location]",
            "name": "default",
            "dependsOn": [
                "[variables('workspaceDeploymentId')]"
            ],
            "properties": {
                "workspaceId": "[variables('workspaceId')]",
                "logs": [
                    {
                        "category": "Administrative",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "Security",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "ServiceHealth",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "Alert",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "Recommendation",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "Policy",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "Autoscale",
                        "enabled": "[variables('logsEnabled')]"
                    },
                    {
                        "category": "ResourceHealth",
                        "enabled": "[variables('logsEnabled')]"
                    }
                ]
            }
        },

        // Deploy azure security center settings
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "AppServices",
            "properties": {
                "pricingTier": "[parameters('enableAscForAppServices')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "Arm",
            "properties": {
                "pricingTier": "[parameters('enableAscForArm')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "ContainerRegistry",
            "properties": {
                "pricingTier": "[parameters('enableAscForRegistries')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "Dns",
            "properties": {
                "pricingTier": "[parameters('enableAscForDns')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "VirtualMachines",
            "properties": {
                "pricingTier": "[parameters('enableAscForServers')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "SqlServers",
            "properties": {
                "pricingTier": "[parameters('enableAscForSql')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "SqlServerVirtualMachines",
            "properties": {
                "pricingTier": "[parameters('enableAscForSqlOnVm')]"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2018-06-01",
            "name": "StorageAccounts",
            "properties": {
                "pricingTier": "[parameters('enableAscForStorage')]"
            }
        },
        {
            "type": "Microsoft.Security/securityContacts",
            "apiVersion": "2020-01-01-preview",
            "name": "default",
            "properties": {
                "emails": "[parameters('emailSecurityContact')]",
                "notificationsByRole": {
                    "state": "On",
                    "roles": [
                        "Owner"
                    ]
                },
                "alertNotifications": {
                    "state": "On",
                    "minimalSeverity": "High"
                }
            }
        },
        {
            "type": "Microsoft.Security/autoProvisioningSettings",
            "apiVersion": "2017-08-01-preview",
            "name": "default",
            "properties": {
                "autoProvision": "On"
            }
        },
        {
            "type": "Microsoft.Security/workspaceSettings",
            "apiVersion": "2017-08-01-preview",
            "name": "default",
            "dependsOn": [
                "[variables('workspaceDeploymentId')]"
            ],
            "properties": {
                "scope": "[subscription().id]",
                "workspaceId": "[variables('workspaceId')]"
            }
        },

        // Create policies
        {
            "name": "[variables('policyDefinitionName-ASCEnableAppService')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for App Service",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for App Service.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "AppServices",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForAppServices')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "AppServices",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForAppServices')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableARM')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for Azure Resource Manager (ARM)",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for Azure Resource Manager (ARM).",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "Arm",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForArm')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "Arm",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForArm')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableContainer')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for Container Registry",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for Container Registry",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "ContainerRegistry",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForRegistries')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "ContainerRegistry",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForRegistries')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableDNS')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for DNS",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for DNS.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "Dns",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForDns')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "Dns",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForDns')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableServers')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for Servers",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for Servers.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "VirtualMachines",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForServers')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "VirtualMachines",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForServers')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableSqlServers')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for Azure SQL Database",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for Azure SQL Database.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "SqlServers",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForSql')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "SqlServers",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForSql')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableSqlServerVMs')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for SQL Servers on machines",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for SQL Servers on machines.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "SqlServerVirtualMachines",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForSqlOnVm')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "SqlServerVirtualMachines",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForSqlOnVm')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableStorageAccounts')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable Azure Defender for Storage Accounts",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables Azure Defender for Storage Accounts",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {},
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Security/pricings",
                            "name": "StorageAccounts",
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "existenceCondition": {
                                "field": "Microsoft.Security/pricings/pricingTier",
                                "equals": "[parameters('enableAscForStorage')]"
                            },
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "parameters": {},
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {},
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/pricings",
                                                "apiVersion": "2018-06-01",
                                                "name": "StorageAccounts",
                                                "properties": {
                                                    "pricingTier": "[parameters('enableAscForStorage')]"
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[variables('policyDefinitionName-ASCEnableSecurityContacts')]",
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "properties": {
                "displayName": "Enable security alerts notifications",
                "policyType": "Custom",
                "mode": "All",
                "description": "This policy enables security alerts notifications",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Security Center",
                    "securityCenter": {
                        "Severity": "Medium"
                    }
                },
                "parameters": {
                    "emailSecurityContact": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Security contacts email address",
                            "description": "Provide email address for Azure Security Center contact details"
                        }
                    }
                },
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Resources/subscriptions"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "deploymentScope": "subscription",
                            "existenceScope": "subscription",
                            "type": "Microsoft.Security/securityContacts",
                            "existenceCondition": {
                                "allOf": [
                                    {
                                        "field": "Microsoft.Security/securityContacts/email",
                                        "equals": "[[parameters('emailSecurityContact')]"
                                    }
                                ]
                            },
                            "roleDefinitionIds": [
                                "[variables('roleId-SecurityAdmin')]"
                            ],
                            "deployment": {
                                "location": "[deployment().location]",
                                "properties": {
                                    "mode": "incremental",
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "emailSecurityContact": {
                                                "type": "string"
                                            }
                                        },
                                        "variables": {},
                                        "resources": [
                                            {
                                                "type": "Microsoft.Security/securityContacts",
                                                "apiVersion": "2020-01-01-preview",
                                                "name": "default",
                                                "properties": {
                                                    "emails": "[[parameters('emailSecurityContact')]",
                                                    "notificationsByRole": {
                                                        "state": "On",
                                                        "roles": [
                                                            "Owner"
                                                        ]
                                                    },
                                                    "alertNotifications": {
                                                        "state": "On",
                                                        "minimalSeverity": "High"
                                                    }
                                                }
                                            }
                                        ],
                                        "outputs": {}
                                    },
                                    "parameters": {
                                        "emailSecurityContact": {
                                            "value": "[[parameters('emailSecurityContact')]"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },

        // Creates a new policy set including all policies related with ASC deployment
        {
            "name": "[variables('policySetDefinitionName-ASCEnableSecurityCenter')]",
            "type": "Microsoft.Authorization/policySetDefinitions",
            "apiVersion": "2019-09-01",
            "dependsOn": [
                "[variables('policyDefinitionId-ASCEnableAppService')]",
                "[variables('policyDefinitionId-ASCEnableARM')]",
                "[variables('policyDefinitionId-ASCEnableContainer')]",
                "[variables('policyDefinitionId-ASCEnableDNS')]",
                "[variables('policyDefinitionId-ASCEnableServers')]",
                "[variables('policyDefinitionId-ASCEnableSqlServers')]",
                "[variables('policyDefinitionId-ASCEnableSqlServerVMs')]",
                "[variables('policyDefinitionId-ASCEnableStorageAccounts')]",
                "[variables('policyDefinitionId-ASCEnableSecurityContacts')]"
            ],
            "properties": {
                "displayName": "Security policies to enforce compliance",
                "metadata": {
                    "ASC": "true"
                },
                "parameters": {
                    "emailSecurityContact": {
                        "type": "string"
                    },
                    "logAnalytics": {
                        "type": "string"
                    }
                },
                "policyDefinitions": [
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableAutoProvision')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableAutoProvision')]",
                        "parameters": {
                            "logAnalytics": {
                                "value": "[[parameters('logAnalytics')]"
                            }
                        }
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableAppService')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableAppService')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableARM')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableARM')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableContainer')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableContainer')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableDNS')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableDNS')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableServers')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableServers')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableSqlServers')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableSqlServers')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableSqlServerVMs')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableSqlServerVMs')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableStorageAccounts')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableStorageAccounts')]"
                    },
                    {
                        "policyDefinitionReferenceId": "[variables('policyDefinitionName-ASCEnableSecurityContacts')]",
                        "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableSecurityContacts')]",
                        "parameters": {
                            "emailSecurityContact": {
                                "value": "[[parameters('emailSecurityContact')]"
                            }
                        }
                    }
                ]
            }
        },

        // Assign policies initiatives to subscription
        {
            // Azure Security Benchmark
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2020-09-01",
            "name": "[variables('policyAssignmentName-AzureSecurityBenchmark')]",
            "properties": {  
                "policyDefinitionId": "[variables('policyDefinitionId-AzureSecurityBenchmark')]",
                "parameters": {
                    "identityDesignateLessThanOwnersMonitoringEffect": {
                        "value": "Disabled"
                    },
                    "useRbacRulesMonitoringEffect": {
                        "value": "Disabled"
                    },
                    "useServicePrincipalToProtectSubscriptionsMonitoringEffect": {
                        "value": "Disabled"
                    },
                    "identityEnableMFAForOwnerPermissionsMonitoringEffect": {
                        "value": "Disabled"
                    },
                    "networkWatcherShouldBeEnabledMonitoringEffect": {
                        "value": "Disabled"
                    },
                    "autoProvisioningOfTheLogAnalyticsAgentShouldBeEnabledOnYourSubscriptionMonitoringEffect": {
                        "value": "Disabled"
                    }
                }
            }
        },
        {
            // CIS Microsoft Azure Foundations Benchmark
            "condition": "[equals(parameters('enableCISInitiative'), 'Yes')]",
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2020-09-01",
            "name": "[variables('policyAssignmentName-CISMicrosoftAzureFoundationsBenchmarks')]",
            "properties": {
                "policyDefinitionId": "[variables('policyDefinitionId-CISMicrosoftAzureFoundationsBenchmarks')]"
            }
        },

        // Assign policies sets to subscription
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2020-09-01",
            "name": "[variables('policyAssignmentName-SendActivityLogToLog')]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('workspaceDeploymentId')]",
                "[subscriptionResourceId('Microsoft.Insights/diagnosticSettings', 'default')]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "description": "Enforce activity log to be sent to the log workspace",
                "displayName": "[variables('policyAssignmentName-SendActivityLogToLog')]",
                "policyDefinitionId": "[variables('policyDefinitionId-SendActivityLogToLog')]",
                "parameters": {
                    "logAnalytics": {
                        "value": "[variables('workspaceId')]"
                    },
                    "logsEnabled": {
                        "value": "[variables('logsEnabled')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "apiVersion": "2020-09-01",
            "name": "[variables('policyAssignmentName-EnableSecurityCenter')]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('workspaceDeploymentId')]",
                "[variables('policyDefinitionId-ASCEnableSecurityCenter')]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "description": "Enforce Azure Security Center to be enabled and configured for the subscription",
                "displayName": "[variables('policyAssignmentName-EnableSecurityCenter')]",
                "policyDefinitionId": "[variables('policyDefinitionId-ASCEnableSecurityCenter')]",
                "parameters": {
                    "emailSecurityContact": {
                        "value": "[parameters('emailSecurityContact')]"
                    },
                    "logAnalytics": {
                        "value": "[variables('workspaceId')]"
                    }
                }
            }
        },

        // Role assignments to policy assignments
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2021-04-01-preview",
            "name": "[guid(variables('policyAssignmentName-SendActivityLogToLog'), variables('roleId-MonitoringContributor'), parameters('deploymentUniqueId'))]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('policyAssignmentId-SendActivityLogToLog')]"
            ],
            "properties": {
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[variables('roleId-MonitoringContributor')]",
                "principalId": "[reference(variables('policyAssignmentId-SendActivityLogToLog'), '2020-03-01', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2021-04-01-preview",
            "name": "[guid(variables('policyAssignmentName-SendActivityLogToLog'), variables('roleId-LogAnalyticsContributor'), parameters('deploymentUniqueId'))]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('policyAssignmentId-SendActivityLogToLog')]"
            ],
            "properties": {
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[variables('roleId-LogAnalyticsContributor')]",
                "principalId": "[reference(variables('policyAssignmentId-SendActivityLogToLog'), '2020-03-01', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2021-04-01-preview",
            "name": "[guid(variables('policyAssignmentName-EnableSecurityCenter'), variables('roleId-Contributor'), parameters('deploymentUniqueId'))]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('policyAssignmentId-EnableSecurityCenter')]"
            ],
            "properties": {
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[variables('roleId-Contributor')]",
                "principalId": "[reference(variables('policyAssignmentId-EnableSecurityCenter'), '2020-03-01', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2021-04-01-preview",
            "name": "[guid(variables('policyAssignmentName-EnableSecurityCenter'), variables('roleId-SecurityAdmin'), parameters('deploymentUniqueId'))]",
            "location": "[deployment().location]",
            "dependsOn": [
                "[variables('policyAssignmentId-EnableSecurityCenter')]"
            ],
            "properties": {
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[variables('roleId-SecurityAdmin')]",
                "principalId": "[reference(variables('policyAssignmentId-EnableSecurityCenter'), '2020-03-01', 'Full').identity.principalId]"
            }
        }
    ],
    "outputs": {
    }
}
